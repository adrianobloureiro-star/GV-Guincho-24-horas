<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Guincho GV 24 Horas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }

    .container{
      max-width:1100px; margin:auto; background:#fff; padding:20px;
      border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1);
    }

    .titulo{
      text-align:center;
      font-size:40px;
      margin:0 0 6px 0;
      font-weight:800;
      text-decoration: underline;
    }
    .titulo .vermelho{ color:#c00000; }

    /* Logo sem espa√ßo ‚Äúfantasma‚Äù */
    .logo{ text-align:center; margin:0; line-height:0; }
    .logo img{ display:block; margin:0 auto; max-width:260px; width:100%; height:auto; }

    h2{ text-align:center; margin:10px 0 15px 0; }

    .linha{ display:flex; gap:10px; flex-wrap:wrap; }
    input{
      flex:1; min-width:260px; padding:12px; font-size:16px;
      border:1px solid #cfd6dd; border-radius:8px;
    }

    /* Bot√µes */
    .botoes{
      display:flex; gap:12px; justify-content:center; align-items:center;
      flex-wrap:wrap; margin-top:12px;
    }

    /* ====== AJUSTE AQUI ====== */
    /* Em desktop, mant√©m bom tamanho, mas permite quebrar com responsividade */
    .botoes button{
      flex: 0 1 220px;        /* base 220px, mas pode encolher/expandir conforme tela */
      padding:12px;
      font-size:16px;
      border:none;
      border-radius:10px;
      color:#fff;
      cursor:pointer;
      width:auto;             /* remove travas */
      max-width:220px;        /* limita no desktop */
    }

    /* No celular: 3 bot√µes por linha */
    @media (max-width: 520px){
      body{ padding:12px; }
      .container{ padding:14px; }

      .botoes{ gap:10px; }

      .botoes button{
        flex: 1 1 calc(33.333% - 10px); /* 3 por linha */
        max-width: none;                 /* libera largura */
        padding:12px 8px;                /* cabe melhor */
        font-size:14px;
      }

      /* opcional: t√≠tulo menor no celular */
      .titulo{ font-size:32px; }
      input{ min-width: 100%; }          /* inputs ficam 1 por linha no celular */
    }
    /* ====== FIM DO AJUSTE ====== */

    .btn-azul{ background:#1a73e8; } .btn-azul:hover{ background:#1558b0; }
    .btn-verde{ background:#16a34a; } .btn-verde:hover{ background:#15803d; }
    .btn-cinza{ background:#344054; } .btn-cinza:hover{ background:#1f2937; }
    .btn-wpp{ background:#25D366; } .btn-wpp:hover{ background:#1fb457; }

    #resultado{
      margin-top:15px; padding:12px; background:#f9f9f9;
      border-radius:10px; border:1px solid #e1e5ea;
    }
    .erro{ color:#c00000; }
    .muted{ color:#6b7280; font-size:13px; margin-top:6px; }

    #map{ margin-top:15px; height:420px; border-radius:12px; overflow:hidden; }

    footer{ margin-top:25px; text-align:center; font-size:14px; color:#666; }
    footer b{ color:#000; }

    /* Modal */
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
      justify-content:center; align-items:center; padding:16px;
    }
    .modal-content{
      background:#fff; width:100%; max-width:420px; border-radius:12px;
      padding:18px; box-shadow:0 8px 30px rgba(0,0,0,.2);
    }
    .modal-content h3{ margin:0 0 10px 0; }
    .modal-content input{ width:100%; min-width:0; margin-top:10px; }
    .modal-actions{ display:flex; gap:10px; margin-top:12px; }
    .modal-actions button{ flex:1; width:auto; }
  </style>
</head>

<body>
  <div class="container">
    <div class="titulo">
      Guincho GV <span class="vermelho">24 Horas</span>
    </div>

    <div class="logo">
      <img src="logo-gv-guincho.png" alt="GV Guincho" />
    </div>

    <h2>Calcular rota, tempo e dist√¢ncia (carro)</h2>

    <div class="linha">
      <input id="origem" placeholder="Endere√ßo de origem" />
      <input id="destino" placeholder="Endere√ßo de destino" />
    </div>

    <div class="botoes">
      <button class="btn-verde" id="btnLocalizacao">üìç Localiza√ß√£o</button>
      <button class="btn-cinza" id="btnInverter">üîÅ Inverter</button>
      <button class="btn-azul" id="btnCalcular">Calcular</button>
      <button class="btn-wpp" id="btnWhats">üí¨ WhatsApp</button>
    </div>

    <div id="resultado">
      Preencha os endere√ßos e clique em <b>Calcular</b>.
      <div class="muted">Dica: clique em <b>üìç Localiza√ß√£o</b> para preencher a origem automaticamente.</div>
    </div>

    <div id="map"></div>

    <footer>
      Desenvolvido por <b>Braztec</b> | Contato: <b>27 99836-1919</b>
    </footer>
  </div>

  <!-- Modal Nome -->
  <div class="modal" id="modalNome">
    <div class="modal-content">
      <h3>Digite seu nome</h3>
      <input type="text" id="nomeCliente" placeholder="Seu nome" />
      <div class="modal-actions">
        <button class="btn-cinza" id="btnCancelar">Cancelar</button>
        <button class="btn-azul" id="btnEnviar">Enviar</button>
      </div>
      <div class="muted">O telefone ser√° o do seu WhatsApp ao enviar a mensagem.</div>
    </div>
  </div>

  <script>
    let map, directionsService, directionsRenderer, geocoder;

    // ======= PRE√áOS (edite aqui quando quiser) =======
    let TARIFA_BASE = 50.00;   // valor fixo (R$)
    let VALOR_POR_KM = 4.50;   // valor por km (R$)

    // ======= WHATSAPP =======
    const WHATSAPP_NUMERO = "5527995993430"; // DDI55 + DDD + n√∫mero

    // √öltimo c√°lculo (quando houver)
    let ultimoResumo = null;

    // √öltima localiza√ß√£o capturada pelo üìç (lat/lng)
    let ultimaLocalizacao = null; // { lat, lng } ou null

    function brl(v) {
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function setResultado(html) {
      document.getElementById("resultado").innerHTML = html;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -20.3155, lng: -40.3128 }, // Vit√≥ria/ES (padr√£o)
        zoom: 12
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();

      // Autocomplete (BR)
      const options = { types: ["geocode"], componentRestrictions: { country: "br" } };
      new google.maps.places.Autocomplete(document.getElementById("origem"), options);
      new google.maps.places.Autocomplete(document.getElementById("destino"), options);

      // Bot√µes
      document.getElementById("btnLocalizacao").addEventListener("click", usarMinhaLocalizacao);
      document.getElementById("btnInverter").addEventListener("click", inverter);
      document.getElementById("btnCalcular").addEventListener("click", calcularRota);
      document.getElementById("btnWhats").addEventListener("click", abrirModal);

      document.getElementById("btnCancelar").addEventListener("click", fecharModal);
      document.getElementById("btnEnviar").addEventListener("click", enviarWhats);

      // Enter no destino = calcular
      document.getElementById("destino").addEventListener("keydown", (e) => {
        if (e.key === "Enter") calcularRota();
      });

      // Tenta localiza√ß√£o autom√°tica apenas se j√° estiver permitida (sem incomodar)
      tentarLocalizacaoAutomatica();
    }

    async function tentarLocalizacaoAutomatica() {
      try {
        if (!navigator.geolocation) return;

        if (navigator.permissions?.query) {
          const p = await navigator.permissions.query({ name: "geolocation" });
          if (p.state === "granted") usarMinhaLocalizacao();
        }
      } catch (_) {}
    }

    function usarMinhaLocalizacao() {
      if (!navigator.geolocation) {
        setResultado("<span class='erro'>Seu navegador n√£o suporta geolocaliza√ß√£o.</span>");
        return;
      }

      setResultado("Obtendo sua localiza√ß√£o‚Ä¶");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          ultimaLocalizacao = latlng;

          map.setCenter(latlng);
          map.setZoom(15);

          // Reverse geocoding: coordenadas -> endere√ßo
          geocoder.geocode({ location: latlng }, (results, status) => {
            if (status === "OK" && results && results.length) {
              document.getElementById("origem").value = results[0].formatted_address;
              setResultado("Origem preenchida com sua localiza√ß√£o. Agora informe o destino e clique em <b>Calcular</b>.");
            } else {
              // fallback
              document.getElementById("origem").value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
              setResultado("Localiza√ß√£o obtida, mas n√£o foi poss√≠vel converter para endere√ßo. Preenchemos com coordenadas.");
            }
          });

          ultimoResumo = null;
        },
        (err) => {
          const msg =
            err.code === 1 ? "Permiss√£o negada. Clique em üìç e permita a localiza√ß√£o." :
            err.code === 2 ? "N√£o foi poss√≠vel obter sua localiza√ß√£o (sinal fraco). Tente novamente." :
            "N√£o foi poss√≠vel obter sua localiza√ß√£o. Tente novamente.";
          setResultado(`<span class='erro'>${msg}</span>`);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function inverter() {
      const o = document.getElementById("origem");
      const d = document.getElementById("destino");
      const tmp = o.value;
      o.value = d.value;
      d.value = tmp;
      ultimoResumo = null;
    }

    function calcularRota() {
      const origem = document.getElementById("origem").value.trim();
      const destino = document.getElementById("destino").value.trim();

      if (!origem || !destino) {
        setResultado("<span class='erro'>Informe origem e destino.</span>");
        return;
      }

      directionsService.route(
        {
          origin: origem,
          destination: destino,
          travelMode: google.maps.TravelMode.DRIVING
        },
        (response, status) => {
          if (status !== "OK" || !response?.routes?.length) {
            setResultado(`<span class='erro'>Erro ao calcular rota. (${status})</span>`);
            return;
          }

          directionsRenderer.setDirections(response);

          const rota = response.routes[0].legs[0];
          const km = rota.distance.value / 1000;
          const total = TARIFA_BASE + (km * VALOR_POR_KM);

          // Link da "Minha localiza√ß√£o" (prioriza lat/lng capturados no üìç; sen√£o usa o endere√ßo de origem)
          const linkMinhaLocalizacao = ultimaLocalizacao
            ? `https://www.google.com/maps/search/?api=1&query=${ultimaLocalizacao.lat},${ultimaLocalizacao.lng}`
            : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(rota.start_address)}`;

          ultimoResumo = {
            origem: rota.start_address,
            destino: rota.end_address,
            distancia: rota.distance.text,
            tempo: rota.duration.text,
            preco: brl(total),
            linkMinhaLocalizacao
          };

          setResultado(`
            <b>Origem:</b> ${rota.start_address}<br>
            <b>Destino:</b> ${rota.end_address}<br><br>
            <b>Dist√¢ncia:</b> ${rota.distance.text}<br>
            <b>Tempo estimado:</b> ${rota.duration.text}<br><br>
            <b>Valor estimado:</b> ${brl(total)}<br>
            <span class="muted">(${brl(TARIFA_BASE)} + ${km.toFixed(2)} km √ó ${brl(VALOR_POR_KM)})</span>
          `);
        }
      );
    }

    function abrirModal() {
      document.getElementById("nomeCliente").value = "";
      document.getElementById("modalNome").style.display = "flex";
      setTimeout(() => document.getElementById("nomeCliente").focus(), 50);
    }

    function fecharModal() {
      document.getElementById("modalNome").style.display = "none";
    }

    function enviarWhats() {
      const nome = document.getElementById("nomeCliente").value.trim();
      if (!nome) {
        alert("Digite seu nome.");
        return;
      }

      const origem = document.getElementById("origem").value.trim();
      const destino = document.getElementById("destino").value.trim();

      let msg = `Ol√°! Meu nome √© ${nome}.\nGostaria de solicitar atendimento de guincho e um or√ßamento. üöóüõª\n`;

      // Link "Minha localiza√ß√£o" (se capturou no üìç usa lat/lng; sen√£o usa a origem digitada)
      const linkMinhaLocalizacao = ultimaLocalizacao
        ? `https://www.google.com/maps/search/?api=1&query=${ultimaLocalizacao.lat},${ultimaLocalizacao.lng}`
        : (origem ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(origem)}` : "");

      // Caso 1: j√° calculou
      if (ultimoResumo) {
        const protocolo = "GV-" + Date.now().toString().slice(-6);

        msg += `\nProtocolo: ${protocolo}\n`;
        msg += `Origem: ${ultimoResumo.origem}\nDestino: ${ultimoResumo.destino}\n`;
        msg += `Dist√¢ncia: ${ultimoResumo.distancia}\nTempo estimado: ${ultimoResumo.tempo}\n`;
        msg += `Or√ßamento estimado: ${ultimoResumo.preco}\n`;

        if (ultimoResumo.linkMinhaLocalizacao) {
          msg += `\nMinha localiza√ß√£o: ${ultimoResumo.linkMinhaLocalizacao}\n`;
        } else if (linkMinhaLocalizacao) {
          msg += `\nMinha localiza√ß√£o: ${linkMinhaLocalizacao}\n`;
        }
      }
      // Caso 2: n√£o calculou, mas tem origem e destino
      else if (origem && destino) {
        msg += `\nOrigem: ${origem}\nDestino: ${destino}\n`;
        msg += `\nPode me passar o or√ßamento para esse trajeto?\n`;

        if (linkMinhaLocalizacao) {
          msg += `\nMinha localiza√ß√£o: ${linkMinhaLocalizacao}\n`;
        }
      }
      // Caso 3: n√£o preencheu nada
      else {
        msg += `\nEstou com necessidade de guincho. Pode me informar como funciona e o valor aproximado?\n`;
        msg += `\n(Se precisar, posso enviar minha localiza√ß√£o e o destino.)\n`;
      }

      const url = `https://wa.me/${WHATSAPP_NUMERO}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");

      fecharModal();
    }
  </script>

  <!-- Google Maps JS + Places -->
  <script
    async
    defer
   src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCCNAa-Zu-wK5Bov5P1rNYgubIhrICYaM&libraries=places&callback=initMap">
    </script>
</body>
</html>
